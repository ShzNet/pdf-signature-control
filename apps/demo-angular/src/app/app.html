<header class="app-header">
  <span>PDF Sign Demo (Angular)</span>
</header>

<aside class="left-panel">
  <div class="panel-title">Signature</div>
  <button class="btn-primary" (click)="openModal()" style="margin-bottom: 20px;">
    + Add Signature Field
  </button>

  <div class="panel-title">Generic Field</div>
  <div class="form-container" style="display: flex; flex-direction: column; gap: 10px; font-size: 13px;">
    <!-- Keep generic add field for testing -->
    <div class="form-row" style="display: flex; gap: 5px;">
      <div class="form-group" style="flex: 1;">
        <label>Page</label>
        <input type="number" [(ngModel)]="newField.page" min="1" style="width: 100%;">
      </div>
      <div class="form-group" style="flex: 1;">
        <label>Type</label>
        <select [(ngModel)]="newField.type" style="width: 100%;">
          <option value="text">Text</option>
          <option value="html">HTML</option>
          <option value="image">Image</option>
        </select>
      </div>
    </div>
    <div class="form-group">
      <label>Content</label>
      <input type="text" [(ngModel)]="newField.content" style="width: 100%;">
    </div>

    <div class="flags-row" style="display: flex; flex-wrap: wrap; gap: 10px;">
      <label><input type="checkbox" [(ngModel)]="newField.draggable"> Moveable</label>
      <label><input type="checkbox" [(ngModel)]="newField.resizable"> Resizable</label>
      <label><input type="checkbox" [(ngModel)]="newField.deletable"> Deletable</label>
    </div>

    <button class="btn-secondary" (click)="handleAddField()" style="width: 100%;">Add Generic Field</button>
  </div>
</aside>

<main class="main-content">
  <div class="toolbar">
    <div class="control-group">
      <button (click)="prevPage()" title="Previous Page">◀</button>
      <span id="page-info" style="min-width: 80px; text-align: center;">{{ pageInfo }}</span>
      <button (click)="nextPage()" title="Next Page">▶</button>
    </div>

    <div class="divider"></div>

    <div class="control-group">
      <button (click)="zoomOut()" title="Zoom Out">−</button>
      <span id="zoom-info" style="min-width: 50px; text-align: center;">{{ zoomInfo }}</span>
      <button (click)="zoomIn()" title="Zoom In">+</button>
    </div>

    <div class="divider"></div>

    <div class="control-group">
      <select [(ngModel)]="viewMode">
        <option value="scroll">Scroll Mode</option>
        <option value="single">Single Page</option>
      </select>
    </div>
  </div>

  <div class="pdf-container">
    <lib-pdf-sign-angular [src]="pdfUrl" [viewMode]="viewMode" [pdfLoaderOptions]="pdfLoaderOptions" [fields]="fields"
      (ready)="onControlReady($event)" (pageChange)="onPageChange($event)" (scaleChange)="onScaleChange($event)"
      (fieldsChange)="onFieldsChange($event)" (error)="onError($event)"
      style="width: 100%; height: 100%; display: block;"></lib-pdf-sign-angular>
  </div>
</main>

<aside class="right-panel">
  <div class="properties-panel">
    <div class="panel-title">Fields</div>
    <div class="field-list" style="display: flex; flex-direction: column; gap: 8px;">
      <div *ngIf="fields.length === 0" style="color: #999; font-size: 12px; font-style: italic; padding: 10px;">
        No fields yet
      </div>

      <div *ngFor="let field of fields; let i = index" class="field-item"
        style="padding: 10px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 12px; margin-bottom: 5px; background: white;">

        <div style="font-weight: bold; margin-bottom: 5px; display: flex; justify-content: space-between;">
          <span>{{ i + 1 }}. {{ field.type | uppercase }} (P{{ field.pageIndex + 1 }})</span>
          <button
            style="padding: 2px 5px; font-size: 10px; background: #ff4d4f; color: white; border: none; border-radius: 3px;"
            (click)="removeField(field.id)">X</button>
        </div>

        <!-- Props Checkboxes -->
        <div style="display: flex; gap: 8px; font-size: 10px;">
          <label>
            <input type="checkbox" [(ngModel)]="field.draggable" (ngModelChange)="refreshFields()"> Drag
          </label>
          <label>
            <input type="checkbox" [(ngModel)]="field.resizable" (ngModelChange)="refreshFields()"> Resize
          </label>
        </div>
      </div>
    </div>
  </div>
</aside>

<!-- Signature Modal -->
<div class="modal-overlay" *ngIf="isModalOpen">
  <div class="modal-content sig-modal">
    <div class="sig-modal-header">
      <h3>Cấu hình chữ ký</h3>
      <button class="close-btn" (click)="closeModal()">×</button>
    </div>

    <div class="sig-modal-body">
      <!-- Tabs -->
      <div class="sig-tabs">
        <div class="sig-tab" [class.active]="activeTab === 'drawing'" (click)="switchTab('drawing')">Vẽ tay</div>
        <div class="sig-tab" [class.active]="activeTab === 'certName'" (click)="switchTab('certName')">Tên</div>
        <div class="sig-tab" [class.active]="activeTab === 'image'" (click)="switchTab('image')">Tải ảnh</div>
      </div>

      <div class="sig-modal-content">
        <!-- Left Panel -->
        <div class="sig-left-panel">
          <!-- Drawing Tab -->
          <div class="tab-content" [class.hidden]="activeTab !== 'drawing'">
            <div class="signature-pad-container">
              <canvas #signatureCanvas class="signature-pad"></canvas>
            </div>

            <div class="sig-controls">
              <div class="control-row">
                <button class="color-btn" style="background:#2563eb" [class.active]="drawingColor === '#2563eb'"
                  (click)="setDrawingColor('#2563eb')"></button>
                <button class="color-btn" style="background:#000000" [class.active]="drawingColor === '#000000'"
                  (click)="setDrawingColor('#000000')"></button>
                <button class="color-btn" style="background:#dc2626" [class.active]="drawingColor === '#dc2626'"
                  (click)="setDrawingColor('#dc2626')"></button>
              </div>
              <div class="control-row">
                <button class="pen-btn" [class.active]="penWidth === 1" (click)="setPenWidth(1)"
                  style="width:24px; height:24px; display:flex; align-items:center; justify-content:center;">
                  <div style="width:4px; height:4px; background:white; border-radius:50%;"></div>
                </button>
                <button class="pen-btn" [class.active]="penWidth === 3" (click)="setPenWidth(3)"
                  style="width:28px; height:28px; display:flex; align-items:center; justify-content:center;">
                  <div style="width:8px; height:8px; background:white; border-radius:50%;"></div>
                </button>
              </div>
            </div>
          </div>

          <!-- Name Tab -->
          <div class="tab-content" [class.hidden]="activeTab !== 'certName'">
            <div class="certname-input-container">
              <input type="text" class="certname-input" placeholder="Nhập tên của bạn" [(ngModel)]="certName"
                (input)="updatePreview()">
            </div>
          </div>

          <!-- Image Tab -->
          <div class="tab-content" [class.hidden]="activeTab !== 'image'">
            <div class="image-upload-container" (click)="triggerImageUpload()">
              <input type="file" id="sig-image-upload" hidden accept="image/*" (change)="onImageSelected($event)">
              <div class="image-preview" *ngIf="selectedImage; else uploadPlaceholder">
                <img [src]="selectedImage" style="max-width:100%; max-height:100%; object-fit:contain;">
              </div>
              <ng-template #uploadPlaceholder>
                <div class="upload-placeholder">
                  <div class="upload-icon">☁️</div>
                  <div>Click để chọn ảnh</div>
                  <div style="font-size:12px; margin-top:4px;">(PNG, JPG, SVG)</div>
                </div>
              </ng-template>
            </div>
          </div>

          <!-- Layout Options -->
          <div class="option-group" style="margin-top: 20px;">
            <div class="option-label">Bố cục</div>
            <div class="toggle-group">
              <button class="toggle-btn" [class.active]="sigLayout === 'horizontal'"
                (click)="sigLayout = 'horizontal'; updatePreview()">Ngang</button>
              <button class="toggle-btn" [class.active]="sigLayout === 'vertical'"
                (click)="sigLayout = 'vertical'; updatePreview()">Dọc</button>
            </div>
          </div>
        </div>

        <!-- Right Panel -->
        <div class="sig-right-panel">

          <!-- Information Lines -->
          <div class="option-group">
            <div class="option-label">Nội dung hiển thị</div>
            <div class="info-lines-list">
              <div *ngFor="let line of infoLines; let i = index; trackBy: trackByIndex" class="info-line-item">
                <input type="text" class="info-line-input" [value]="line" (input)="updateInfoLine(i, $event)">
                <button class="remove-line-btn" (click)="removeInfoLine(i)">×</button>
              </div>
              <button class="add-line-btn" (click)="addInfoLine()">+ Thêm dòng</button>
            </div>
          </div>

          <!-- Font Size -->
          <div class="option-group">
            <div class="option-label">Cỡ chữ</div>
            <input type="range" min="3" max="9" class="slider" [(ngModel)]="sigFontSize" (input)="updatePreview()">
          </div>

          <!-- Preview -->
          <div class="option-group">
            <div class="option-label">Xem trước</div>
            <div class="sig-preview">
              <iframe [srcdoc]="previewHtml" style="width:100%; height:100%; border:none;"></iframe>
            </div>
          </div>

        </div>
      </div>
    </div>

    <div class="modal-actions">
      <button class="btn-secondary" (click)="closeModal()">Hủy bỏ</button>
      <button class="sig-confirm-btn" (click)="saveSignature()">Đồng ý</button>
    </div>
  </div>
</div>